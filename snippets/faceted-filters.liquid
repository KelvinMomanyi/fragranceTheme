{%- liquid
  assign sort_by = collection.sort_by | default: collection.default_sort_by
  assign filter_count = 0
  for filter in collection.filters
    assign filter_count = filter_count | plus: filter.active_values.size
  endfor
-%}

<div class="facets-container" id="main-collection-filters">
  <form class="facets-form" id="FacetFiltersForm">
    
    {%- comment -%} Top Bar: Filters + Sort {%- endcomment -%}
    <div class="facets-top-bar">
      
      {%- comment -%} Filter Group (Availability, Price, etc.) {%- endcomment -%}
      <div class="facets-group">
        {%- for filter in collection.filters -%}
          <div class="facet-wrapper">
            <label class="facet-label" for="Filter-{{ filter.label | escape }}">{{ filter.label }}</label>
            
            {%- case filter.type -%}
              {%- when 'list' -%}
                {%- comment -%} List Filters as Select {%- endcomment -%}
                <select 
                  name="{{ filter.values.first.param_name }}" 
                  id="Filter-{{ filter.label | escape }}"
                  class="facet-select"
                  onchange="this.closest('form').submit()"
                >
                  <option value="">All</option>
                  {%- for value in filter.values -%}
                    <option 
                      value="{{ value.value }}" 
                      {% if value.active %}selected{% endif %}
                      {% if value.count == 0 and value.active == false %}disabled{% endif %}
                    >
                      {{ value.label }} ({{ value.count }})
                    </option>
                  {%- endfor -%}
                </select>

              {%- when 'price_range' -%}
                {%- comment -%} Price Filter as Fake Dropdown (Details) {%- endcomment -%}
                <details class="facet-disclosure">
                  <summary class="facet-disclosure__summary">
                    <span class="facet-disclosure__button">
                      {%- if filter.min_value.value or filter.max_value.value -%}
                        {%- if filter.min_value.value -%}{{ filter.min_value.value | money_without_currency }}{%- endif -%}
                        -
                        {%- if filter.max_value.value -%}{{ filter.max_value.value | money_without_currency }}{%- endif -%}
                      {%- else -%}
                        Any price
                      {%- endif -%}
                    </span>
                  </summary>
                  <div class="facet-disclosure__content">
                    <div class="price-range-inputs">
                      <div class="price-field">
                        <label for="Filter-{{ filter.label }}-GTE">Min</label>
                        <input
                          name="{{ filter.min_value.param_name }}"
                          id="Filter-{{ filter.label }}-GTE"
                          type="number"
                          placeholder="0"
                          min="0"
                          max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          {% if filter.min_value.value %}value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                        >
                      </div>
                      <span class="price-separator">-</span>
                      <div class="price-field">
                        <label for="Filter-{{ filter.label }}-LTE">Max</label>
                        <input
                          name="{{ filter.max_value.param_name }}"
                          id="Filter-{{ filter.label }}-LTE"
                          type="number"
                          placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          min="0"
                          max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          {% if filter.max_value.value %}value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                        >
                      </div>
                    </div>
                    <button type="submit" class="price-range__button">Apply</button>
                  </div>
                </details>

            {%- endcase -%}
          </div>
        {%- endfor -%}
      </div>

      {%- comment -%} Sort By {%- endcomment -%}
      <div class="facet-wrapper facet-sort-wrapper">
        <label class="facet-label" for="SortBy">Sort by</label>
        <select name="sort_by" id="SortBy" class="facet-select" onchange="this.closest('form').submit()">
          {%- for option in collection.sort_options -%}
            <option value="{{ option.value }}" {% if option.value == sort_by %}selected="selected"{% endif %}>
              {{ option.name }}
            </option>
          {%- endfor -%}
        </select>
      </div>

    </div>

    {%- comment -%} Active Filters {%- endcomment -%}
    {% if filter_count > 0 %}
      <div class="active-facets">
        <div class="active-facets__list">
          {%- for filter in collection.filters -%}
            {%- for value in filter.active_values -%}
              <a href="{{ value.url_to_remove }}" class="active-facet">
                {{ value.label }} <span class="remove-x">×</span>
              </a>
            {%- endfor -%}
            {%- if filter.type == 'price_range' -%}
              {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
                <a href="{{ filter.url_to_remove }}" class="active-facet">
                  {%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%} - 
                  {%- if filter.max_value.value -%}{{ filter.max_value.value | money }}{%- else -%}{{ filter.range_max | money }}{%- endif -%}
                  <span class="remove-x">×</span>
                </a>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          <a href="{{ collection.url }}" class="active-facets__clear">Clear all</a>
        </div>
      </div>
    {% endif %}
  </form>

  {%- comment -%} Results Count {%- endcomment -%}
  <div class="facets-results">
    <p class="facets-count">
      {{ collection.products_count }} products
    </p>
  </div>
</div>

<style>
  .facets-container {
    margin-bottom: 30px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 20px;
  }

  /* Top Bar Layout */
  .facets-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    flex-wrap: wrap;
    gap: 20px;
  }

  .facets-group {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }

  .facet-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .facet-label {
    font-size: 0.9em;
    font-weight: 600;
    color: #333;
  }

  /* Shared Select Style */
  .facet-select,
  .facet-disclosure__button {
    appearance: none;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px 35px 10px 15px;
    font-size: 0.95em;
    color: #333;
    cursor: pointer;
    min-width: 180px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%23666' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    display: block;
    width: 100%;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .facet-select:focus,
  .facet-disclosure__button:focus {
    border-color: #000;
    outline: none;
  }

  /* Disclosure (Price Dropdown) */
  .facet-disclosure {
    position: relative;
  }

  .facet-disclosure__summary {
    list-style: none;
  }
  .facet-disclosure__summary::-webkit-details-marker {
    display: none;
  }

  .facet-disclosure__content {
    position: absolute;
    top: 100%;
    left: 0;
    width: 300px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    margin-top: 5px;
  }

  .price-range-inputs {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
  }

  .price-field {
    flex: 1;
  }

  .price-field label {
    display: block;
    font-size: 0.8em;
    margin-bottom: 5px;
    color: #666;
  }

  .price-field input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .price-range__button {
    width: 100%;
    padding: 10px;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }

  /* Active Filters */
  .active-facets {
    margin-top: 15px;
  }

  .active-facets__list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .active-facet {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 20px;
    text-decoration: none;
    color: #333;
    font-size: 0.9em;
  }

  .active-facet:hover {
    background: #e0e0e0;
  }

  .remove-x {
    font-weight: bold;
  }

  .active-facets__clear {
    color: #d32f2f;
    text-decoration: underline;
    font-size: 0.9em;
    align-self: center;
  }

  .facets-results {
    margin-top: 15px;
    text-align: right;
    font-size: 0.9em;
    color: #666;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .facets-top-bar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .facets-group {
      flex-direction: column;
    }

    .facet-select,
    .facet-disclosure__button {
      width: 100%;
    }
  }
</style>

<script>
  // Close details when clicking outside
  document.addEventListener('click', function(event) {
    const details = document.querySelectorAll('.facet-disclosure[open]');
    details.forEach(detail => {
      if (!detail.contains(event.target)) {
        detail.removeAttribute('open');
      }
    });
  });
</script>
