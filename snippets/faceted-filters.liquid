{%- liquid
  assign sort_by = collection.sort_by | default: collection.default_sort_by
  assign filter_count = 0
  for filter in collection.filters
    assign filter_count = filter_count | plus: filter.active_values.size
  endfor
-%}

<div class="facets-container" id="main-collection-filters">
  <form class="facets-form" id="FacetFiltersForm">
    
    {%- comment -%} Top Bar: Filters + Sort {%- endcomment -%}
    <div class="facets-top-bar">
      
      {%- comment -%} Filter Group (Availability, Price, etc.) {%- endcomment -%}
      <div class="facets-group">
        {%- for filter in collection.filters -%}
          <div class="facet-wrapper">
            <label class="facet-label" for="Filter-{{ filter.label | escape }}">{{ filter.label }}</label>
            
            {%- case filter.type -%}
              {%- when 'list' -%}
                {%- comment -%} List Filters as Select {%- endcomment -%}
                <select 
                  name="{{ filter.values.first.param_name }}" 
                  id="Filter-{{ filter.label | escape }}"
                  class="facet-select"
                  onchange="this.closest('form').submit()"
                >
                  <option value="">All</option>
                  {%- for value in filter.values -%}
                    <option 
                      value="{{ value.value }}" 
                      {% if value.active %}selected{% endif %}
                      {% if value.count == 0 and value.active == false %}disabled{% endif %}
                    >
                      {{ value.label }} ({{ value.count }})
                    </option>
                  {%- endfor -%}
                </select>

              {%- when 'price_range' -%}
                {%- comment -%} Price Filter as Fake Dropdown (Details) {%- endcomment -%}
                <details class="facet-disclosure">
                  <summary class="facet-disclosure__summary">
                    <span class="facet-disclosure__button">
                      {%- if filter.min_value.value or filter.max_value.value -%}
                        {%- if filter.min_value.value -%}{{ filter.min_value.value | money_without_currency }}{%- endif -%}
                        -
                        {%- if filter.max_value.value -%}{{ filter.max_value.value | money_without_currency }}{%- endif -%}
                      {%- else -%}
                        Any price
                      {%- endif -%}
                    </span>
                  </summary>
                  <div class="facet-disclosure__content">
                    <div class="price-range-inputs">
                      <div class="price-field">
                        <label for="Filter-{{ filter.label }}-GTE">Min</label>
                        <input
                          name="{{ filter.min_value.param_name }}"
                          id="Filter-{{ filter.label }}-GTE"
                          type="number"
                          placeholder="0"
                          min="0"
                          max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          {% if filter.min_value.value %}value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                        >
                      </div>
                      <span class="price-separator">-</span>
                      <div class="price-field">
                        <label for="Filter-{{ filter.label }}-LTE">Max</label>
                        <input
                          name="{{ filter.max_value.param_name }}"
                          id="Filter-{{ filter.label }}-LTE"
                          type="number"
                          placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          min="0"
                          max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          {% if filter.max_value.value %}value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                        >
                      </div>
                    </div>
                    <button type="submit" class="price-range__button">Apply</button>
                  </div>
                </details>

            {%- endcase -%}
          </div>
        {%- endfor -%}
      </div>

      {%- comment -%} Sort By {%- endcomment -%}
      <div class="facet-wrapper facet-sort-wrapper">
        <label class="facet-label" for="SortBy">Sort by</label>
        <select name="sort_by" id="SortBy" class="facet-select" onchange="this.closest('form').submit()">
          {%- for option in collection.sort_options -%}
            <option value="{{ option.value }}" {% if option.value == sort_by %}selected="selected"{% endif %}>
              {{ option.name }}
            </option>
          {%- endfor -%}
        </select>
      </div>

    </div>

    {%- comment -%} Active Filters {%- endcomment -%}
    {% if filter_count > 0 %}
      <div class="active-facets">
        <div class="active-facets__list">
          {%- for filter in collection.filters -%}
            {%- for value in filter.active_values -%}
              <a href="{{ value.url_to_remove }}" class="active-facet">
                {{ value.label }} <span class="remove-x">×</span>
              </a>
            {%- endfor -%}
            {%- if filter.type == 'price_range' -%}
              {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
                <a href="{{ filter.url_to_remove }}" class="active-facet">
                  {%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%} - 
                  {%- if filter.max_value.value -%}{{ filter.max_value.value | money }}{%- else -%}{{ filter.range_max | money }}{%- endif -%}
                  <span class="remove-x">×</span>
                </a>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          <a href="{{ collection.url }}" class="active-facets__clear">Clear all</a>
        </div>
      </div>
    {% endif %}
  document.addEventListener('click', function(event) {
    const details = document.querySelectorAll('.facet-disclosure[open]');
    details.forEach(detail => {
      if (!detail.contains(event.target)) {
        detail.removeAttribute('open');
      }
    });
  });
</script>
